<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCF Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light d-flex justify-content-center align-items-center vh-100">

  <div class="card bg-light bg-opacity-10 shadow-lg rounded-4 mx-4 my-4 w-100" style="height: calc(100vh - 2rem);">
    <div class="card-body d-flex p-3 h-100">

      <!-- Sidebar -->
      <div class="card shadow-lg rounded-4 p-3 d-flex flex-column justify-content-between" style="width: 250px; height: 100%; background-color: #0d0cb5;">
        <div>
          <h4 class="fw-bold d-flex align-items-center mb-5 text-white">
            <i class="bi bi-people-fill me-2"></i> SCF
          </h4>

          <ul class="nav flex-column nav-pills" id="sidebarTabs" role="tablist">
            <li class="nav-item mb-2">
              <button class="nav-link text-white active d-flex align-items-center" id="home-tab-btn" data-bs-toggle="pill" data-bs-target="#home-tab" type="button">
                <i class="bi bi-house-fill me-2"></i> Home
              </button>
            </li>
            <li class="nav-item mb-2">
              <button class="nav-link text-white d-flex align-items-center" id="profile-tab-btn" data-bs-toggle="pill" data-bs-target="#profile-tab" type="button">
                <i class="bi bi-person-circle me-2"></i> Profile
              </button>
            </li>
            <li class="nav-item mb-2">
              <button class="nav-link text-white d-flex align-items-center" id="umbrellas-tab-btn" data-bs-toggle="pill" data-bs-target="#umbrellas-tab" type="button">
                <i class="bi bi-building-fill me-2"></i> Umbrellas
              </button>
            </li>
            <li class="nav-item mb-2">
              <button class="nav-link text-white d-flex align-items-center" id="users-tab-btn" data-bs-toggle="pill" data-bs-target="#users-tab" type="button">
                <i class="bi bi-person-fill me-2"></i> Users
              </button>
            </li>
            <li class="nav-item mb-2">
              <button class="nav-link text-white d-flex align-items-center" id="customers-tab-btn" data-bs-toggle="pill" data-bs-target="#customers-tab" type="button">
                <i class="bi bi-people-fill me-2"></i> Customers
              </button>
            </li>
          </ul>
        </div>
        <div class="mt-3">
          <a href="{{ url_for('logout') }}" class="btn btn-light w-100 d-flex align-items-center justify-content-center">
            <i class="bi bi-box-arrow-right me-2"></i> Logout
          </a>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-grow-1 d-flex flex-column ms-3 h-100">

        <!-- User Profile Summary Section -->
        <div class="row g-3 mb-3">
          <!-- Left Card -->
          <div class="col-md-6">
            <div class="card shadow-sm border border-secondary-subtle rounded-4 bg-secondary-subtle px-3 py-2 small">
              <div class="row mb-2">
                <div class="col-5 text-primary fw-semibold">User Name:</div>
                <div class="col-7 fw-bold">{{user.first_name}} {{user.last_name}}</div>
              </div>
              <div class="row mb-2">
                <div class="col-5 text-primary fw-semibold"><i class="bi bi-envelope-fill me-1"></i>Email:</div>
                <div class="col-7 fw-bold">{{user.email}}</div>
              </div>
              <div class="row mb-2">
                <div class="col-5 text-primary fw-semibold"><i class="bi bi-shield-lock-fill me-1"></i>Role:</div>
                <div class="col-7 fw-bold">{{user.role}}</div>
              </div>
            </div>
          </div>

          <!-- Right Card -->
          <div class="col-md-6">
            <div class="card shadow-sm border border-secondary-subtle rounded-4 bg-secondary-subtle px-3 py-2 small">
              <div class="row mb-2">
                <div class="col-6 text-primary fw-semibold"><i class="bi bi-building me-1"></i>Umbrella:</div>
                <div class="col-6 fw-bold">{{user.umbrella}}</div>
              </div>
              <div class="row mb-2">
                <div class="col-6 text-primary fw-semibold"><i class="bi bi-calendar-fill me-1"></i>Date:</div>
                <div class="col-6 fw-bold">{{ date.strftime('%A, %d %B %Y') }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabs Content Card -->
        <div class="card flex-grow-1 shadow-sm p-3 rounded-4 bg-secondary-subtle">
          <div class="tab-content h-100">

            <!-- Home Tab -->
            <div class="tab-pane fade show active" id="home-tab" role="tabpanel">
              <h5 class="fw-bold mb-3">Home</h5>
              <p>Welcome to the SCF System Dashboard. This is the home tab content.</p>
            </div>

            <!-- Profile Tab -->
            <div class="tab-pane fade" id="profile-tab" role="tabpanel">
              <h5 class="fw-bold mb-3">Profile</h5>

              <!-- User Details List -->
              <ul class="list-group mb-4">
                <li class="list-group-item d-flex justify-content-between align-items-center py-2 bg-dark-subtle my-1 rounded-2">
                  <div class="d-flex flex-column gap-1">
                    <div class="fw-bold text-dark">First Name:</div>
                    <div class="text-primary">{{ user.first_name }}</div>
                  </div>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center py-2 bg-dark-subtle my-1 rounded-2">
                  <div class="d-flex flex-column gap-1">
                    <div class="fw-bold text-dark">Last Name:</div>
                    <div class="text-primary">{{ user.last_name }}</div>
                  </div>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center py-2 bg-dark-subtle my-1 rounded-2">
                  <div class="d-flex flex-column gap-1">
                    <div class="fw-bold text-dark">Email:</div>
                    <div class="text-primary">{{ user.email }}</div>
                  </div>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center py-2 bg-dark-subtle my-1 rounded-2">
                  <div class="d-flex flex-column gap-1">
                    <div class="fw-bold text-dark">Role:</div>
                    <div class="text-primary">{{ user.role }}</div>
                  </div>
                </li>
              </ul>

              <!-- Action Buttons -->
              <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                  Edit Profile
                </button>
                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                  Change Password
                </button>
              </div>
            </div>

            <!-- Umbrellas Tab -->
            <div class="tab-pane fade" id="umbrellas-tab" role="tabpanel">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h5 class="fw-bold mb-1">Umbrellas</h5>
                  <p class="mb-0">Manage umbrella authorities</p>
                </div>
                <div>
                  <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUmbrellaModal">
                    <i class="bi bi-plus-lg me-1"></i> Add Umbrella
                  </button>
                </div>
              </div>

              <div class="overflow-auto" style="max-height: 60vh;">
                <div class="d-flex flex-column gap-2">
                  {% for umbrella in umbrellas %}
    <div class="card shadow-sm border border-secondary-subtle bg-dark-subtle mb-1">
      <div class="card-body d-flex justify-content-between align-items-center py-2 px-2">
        <h6 class="mb-0 fw-semibold text-truncate" style="max-width: 60%; font-size: 0.85rem;">
          {{ umbrella.umbrella }}
        </h6>
        <div class="d-flex gap-1">
          <button class="btn btn-outline-primary btn-sm p-1" data-bs-toggle="modal" data-bs-target="#editModal-{{ umbrella._id }}">
            <i class="bi bi-pencil fs-6"></i>
          </button>
          <button class="btn btn-outline-danger btn-sm p-1" data-bs-toggle="modal" data-bs-target="#deleteModal-{{ umbrella._id }}">
            <i class="bi bi-trash fs-6"></i>
          </button>
        </div>
      </div>
    </div>


                  <!-- Edit Modal -->
                  <div class="modal fade" id="editModal-{{ umbrella._id }}" tabindex="-1" aria-labelledby="editModalLabel-{{ umbrella._id }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <form method="POST" action="{{ url_for('edit_umbrella') }}">
                          <div class="modal-header">
                            <h5 class="modal-title" id="editModalLabel-{{ umbrella._id }}">Edit Umbrella</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <input type="hidden" name="umbrella_id" value="{{ umbrella._id }}">
                            <div class="mb-3">
                              <label for="umbrella_{{ umbrella._id }}" class="form-label">Umbrella Name</label>
                              <input type="text" class="form-control" id="umbrella_{{ umbrella._id }}" name="umbrella" value="{{ umbrella.umbrella }}">
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <!-- Delete Modal -->
                  <div class="modal fade" id="deleteModal-{{ umbrella._id }}" tabindex="-1" aria-labelledby="deleteModalLabel-{{ umbrella._id }}" aria-hidden="true">
                    <div class="modal-dialog">
                      <div class="modal-content">
                        <form method="POST" action="{{ url_for('delete_umbrella') }}">
                          <div class="modal-header">
                            <h5 class="modal-title" id="deleteModalLabel-{{ umbrella._id }}">Delete Umbrella</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <input type="hidden" name="umbrella_id" value="{{ umbrella._id }}">
                            <p>Are you sure you want to delete <strong>{{ umbrella.umbrella }}</strong>?</p>
                          </div>
                          <div class="modal-footer">
                            <button type="submit" class="btn btn-danger">Delete</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>

<!-- Users Tab -->
<div class="tab-pane fade" id="users-tab" role="tabpanel" style="padding: 0.5rem;">

  <!-- Top Section: Add User Button -->
  <div class="d-flex justify-content-start mb-3">
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
      <i class="bi bi-plus-lg"></i> Add User
    </button>
  </div>

  <!-- Users Table -->
  <div class="table-responsive">
    <table class="table table-secondary table-hover table-sm align-middle" style="font-size:0.8rem;">
      <thead class="table-light">
        <tr class="table-primary">
          <th>First Name</th>
          <th>Last Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Umbrella</th>
          <th>Scheme</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for u in users %}
<tr class="bg-dark-subtle my-1">
  <td>{{ u.first_name }}</td>
  <td>{{ u.last_name }}</td>
  <td>{{ u.email }}</td>
  <td>{{ u.role }}</td>
  <td>{{ u.umbrella or '-' }}</td>
  <td>{{ u.scheme or '-' }}</td>
  <td>
    <div class="d-flex gap-1">
      <!-- Edit Button -->
      <button class="btn btn-outline-primary btn-sm p-1" data-bs-toggle="modal" data-bs-target="#editUserModal-{{ u._id }}">
        <i class="bi bi-pencil fs-6"></i>
      </button>

      <!-- Delete Button -->
      <button class="btn btn-outline-danger btn-sm p-1" data-bs-toggle="modal" data-bs-target="#deleteUserModal-{{ u._id }}">
        <i class="bi bi-trash fs-6"></i>
      </button>

      <!-- Change Password Button -->
      <button class="btn btn-outline-warning btn-sm p-1" data-bs-toggle="modal" data-bs-target="#changePasswordModal-{{ u._id }}">
        <i class="bi bi-key fs-6"></i>
      </button>
    </div>
  </td>
</tr>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal-{{ u._id }}" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('update_user') }}">
      <input type="hidden" name="user_id" value="{{ u._id }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" name="first_name" class="form-control mb-2" value="{{ u.first_name }}" required>
          <input type="text" name="last_name" class="form-control mb-2" value="{{ u.last_name }}" required>
          <input type="email" name="email" class="form-control mb-2" value="{{ u.email }}" required>

          <!-- Role -->
          <select name="role" class="form-select mb-2" required>
            <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>Admin</option>
            <option value="manager" {% if u.role == 'manager' %}selected{% endif %}>Manager</option>
            <option value="cluster_manager" {% if u.role == 'cluster_manager' %}selected{% endif %}>Cluster Manager</option>
            <option value="scheme_manager" {% if u.role == 'scheme_manager' %}selected{% endif %}>Scheme Manager</option>
            <option value="plumber" {% if u.role == 'plumber' %}selected{% endif %}>Plumber</option>
            <option value="me_officer" {% if u.role == 'me_officer' %}selected{% endif %}>M&E Officer</option>
          </select>

<!-- Umbrella Authority -->
<select name="umbrella_id" class="form-select mb-2">
  <option value="" {% if not u.umbrella %}selected{% endif %}>Select Umbrella</option>
  {% for umbrella in umbrellas %}
    <option value="{{ umbrella._id }}" {% if u.umbrella_id|string == umbrella._id|string %}selected{% endif %}>
      {{ umbrella.umbrella }}
    </option>
  {% endfor %}
</select>

<!-- Scheme (optional) -->
<select name="scheme_id" class="form-select mb-2">
  <option value="" {% if not u.scheme %}selected{% endif %}>Select Scheme</option>
  {% for scheme in schemes %}
    <option value="{{ scheme._id }}" {% if u.scheme_id|string == scheme._id|string %}selected{% endif %}>
      {{ scheme.scheme }}
    </option>
  {% endfor %}
</select>


        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal-{{ u._id }}" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('delete_user') }}">
      <input type="hidden" name="user_id" value="{{ u._id }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete <strong>{{ u.first_name }} {{ u.last_name }}</strong>?
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Delete</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal-{{ u._id }}" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('change_user_password') }}">
      <input type="hidden" name="user_id" value="{{ u._id }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Change Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="password" name="new_password" class="form-control mb-2" placeholder="New Password" required>
          <input type="password" name="confirm_password" class="form-control" placeholder="Confirm Password" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-warning">Update Password</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endfor %}

      </tbody>
    </table>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('add_user') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" name="first_name" class="form-control mb-2" placeholder="First Name" required>
          <input type="text" name="last_name" class="form-control mb-2" placeholder="Last Name" required>
          <input type="email" name="email" class="form-control mb-2" placeholder="Email" required>
          <input type="password" name="password" class="form-control mb-2" placeholder="Password" required>

          <!-- Role (Admin-only editable) -->
          <select name="role" class="form-select mb-2" required {% if user.role|string != 'admin' %}disabled{% endif %}>
            <option value="" selected disabled>Select Role</option>
            <option value="admin">Admin</option>
            <option value="manager">Manager</option>
            <option value="cluster_manager">Cluster Manager</option>
            <option value="scheme_manager">Scheme Manager</option>
            <option value="plumber">Plumber</option>
            <option value="me_officer">M&E Officer</option>
          </select>

          <!-- Umbrella Authority (Admin-only editable) -->
          <select name="umbrella_id" class="form-select mb-2" required {% if user.role|string != 'admin' %}disabled{% endif %}>
            <option value="" selected disabled>Select Umbrella</option>
            {% for umbrella in umbrellas %}
              <option value="{{ umbrella._id }}">{{ umbrella.umbrella }}</option>
            {% endfor %}
          </select>

          <!-- Scheme (optional) -->
          <select name="scheme_id" class="form-select mb-2">
            <option value="" selected>Select Scheme</option>
            {% for scheme in schemes %}
              <option value="{{ scheme._id }}">{{ scheme.scheme_name }}</option>
            {% endfor %}
          </select>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Add User</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Customers Tab -->
<div class="tab-pane fade" id="customers-tab" role="tabpanel">

  <!-- Header with Add Button -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-bold mb-0">Customers</h5>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
      <i class="bi bi-plus-circle me-1"></i> Add New Customer
    </button>
  </div>

  <!-- Add Customer Modal -->
  <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form method="POST" enctype="multipart/form-data" action="{{url_for('add_customer')}}">
          <div class="modal-header">
            <h5 class="modal-title" id="addCustomerModalLabel">Add New Customer</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body row g-3">
            <div class="col-md-6">
              <label class="form-label">Customer Name *</label>
              <input type="text" class="form-control" name="customer_name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Contact *</label>
              <input type="text" class="form-control" name="contact" required>
            </div>
<div class="col-md-6">
  <label class="form-label">Scheme *</label>
  <select class="form-select" name="scheme_id" required>
    <option value="">Select Scheme</option>
    {% for s in schemes %}
      <option value="{{ s._id }}">{{ s.scheme }}</option>
    {% endfor %}
  </select>
</div>
<div class="col-md-6">
  <label class="form-label">Village</label>
  <select class="form-select" name="village_id">
    <option value="">Select Village</option>
    {% for v in villages %}
      <option value="{{ v._id }}">{{ v.village }}</option>
    {% endfor %}
  </select>
</div>
            <div class="col-md-6">
              <label class="form-label">Application ID</label>
              <input type="text" class="form-control" name="application_id">
            </div>
            <div class="col-md-6">
              <label class="form-label">Customer ID (PDF/Image) *</label>
              <input type="file" class="form-control" name="customer_id_doc" accept="image/*,.pdf">
            </div>
            <div class="col-md-6">
              <label class="form-label">Recommendation Letter *</label>
              <input type="file" class="form-control" name="recommendation_letter" accept="image/*,.pdf">
            </div>
            <div class="col-md-6">
              <label class="form-label">Wealth Assessment Form *</label>
              <input type="file" class="form-control" name="wealth_assessment_form" accept="image/*,.pdf">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Customer</button>
          </div>
        </form>
      </div>
    </div>
  </div>


  <!-- Customers Table -->
  <div class="table-responsive">
    <table class="table table-secondary table-hover table-sm align-middle" style="font-size:0.8rem;">
      <thead class="table-light">
        <tr class="table-primary">
          <th>Customer Name</th>
          <th>Contact</th>
          <th>Scheme</th>
          <th>Village</th>
          <th>Docs</th>
          <th>Status</th>
          <th>Balance</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for c in customers %}
        <tr class="bg-dark-subtle my-1">
          <td>{{ c.customer_name }}</td>
          <td>{{ c.contact }}</td>
          <td>{{ c.scheme }}</td>
          <td>{{ c.village or '-' }}</td>
<td>
  {% if c.customer_id_doc or c.recommendation_letter or c.wealth_assessment_form %}
    {% if c.customer_id_doc %}
      <a href="{{ url_for('static', filename='uploads/' ~ c.customer_id_doc) }}" target="_blank">
        {{ c.customer_id_doc[:5] }}{{ '...' if c.customer_id_doc|length > 5 else '' }}
      </a>{% if c.recommendation_letter or c.wealth_assessment_form %}, {% endif %}
    {% endif %}
    {% if c.recommendation_letter %}
      <a href="{{ url_for('static', filename='uploads/' ~ c.recommendation_letter) }}" target="_blank">
        {{ c.recommendation_letter[:5] }}{{ '...' if c.recommendation_letter|length > 5 else '' }}
      </a>{% if c.wealth_assessment_form %}, {% endif %}
    {% endif %}
    {% if c.wealth_assessment_form %}
      <a href="{{ url_for('static', filename='uploads/' ~ c.wealth_assessment_form) }}" target="_blank">
        {{ c.wealth_assessment_form[:5] }}{{ '...' if c.wealth_assessment_form|length > 5 else '' }}
      </a>
    {% endif %}
  {% endif %}
</td>
          <td>{{ c.status or 'Pending' }}</td>
          <td>{{ c.balance or '0' }}</td>
          <td>
            <div class="d-flex gap-1">
              <!-- Edit Button -->
              <button class="btn btn-outline-primary btn-sm p-1" data-bs-toggle="modal" data-bs-target="#editCustomerModal-{{ c._id }}">
                <i class="bi bi-pencil fs-6"></i>
              </button>

              <!-- Delete Button -->
              <button class="btn btn-outline-danger btn-sm p-1" data-bs-toggle="modal" data-bs-target="#deleteCustomerModal-{{ c._id }}">
                <i class="bi bi-trash fs-6"></i>
              </button>

              <!-- Update Status Button -->
              <button class="btn btn-outline-warning btn-sm p-1" data-bs-toggle="modal" data-bs-target="#updateStatusModal-{{ c._id }}">
                <i class="bi bi-check-circle fs-6"></i>
              </button>
            </div>
          </td>
        </tr>

        <!-- Edit Customer Modal -->
        <div class="modal fade" id="editCustomerModal-{{ c._id }}" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <form method="POST" action="/edit-customer/{{ c._id }}">
                <div class="modal-header">
                  <h5 class="modal-title">Edit Customer - {{ c.customer_name }}</h5>
                  <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Customer Name *</label>
                    <input type="text" class="form-control" name="customer_name" value="{{ c.customer_name }}" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Contact *</label>
                    <input type="text" class="form-control" name="contact" value="{{ c.contact }}" required>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Scheme *</label>
                    <select class="form-select" name="scheme" required>
                      <option value="">Select Scheme</option>
                      {% for s in schemes %}
                        <option value="{{ s }}" {% if c.scheme == s %}selected{% endif %}>{{ s }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Village</label>
                    <select class="form-select" name="village">
                      <option value="">Select Village</option>
                      {% for v in villages %}
                        <option value="{{ v }}" {% if c.village == v %}selected{% endif %}>{{ v }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-success">Update</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Delete Customer Modal -->
        <div class="modal fade" id="deleteCustomerModal-{{ c._id }}" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="POST" action="/delete-customer/{{ c._id }}">
                <div class="modal-header">
                  <h5 class="modal-title text-danger">Delete Customer</h5>
                  <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  Are you sure you want to delete <strong>{{ c.customer_name }}</strong>?
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-danger">Delete</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Update Status Modal -->
        <div class="modal fade" id="updateStatusModal-{{ c._id }}" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="POST" action="/update-customer-status/{{ c._id }}">
                <div class="modal-header">
                  <h5 class="modal-title">Update Status</h5>
                  <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <label class="form-label">New Status</label>
                  <select class="form-select" name="status" required>
                    <option value="">Select</option>
                    <option value="Pending" {% if c.status == "Pending" %}selected{% endif %}>Pending</option>
                    <option value="Active" {% if c.status == "Active" %}selected{% endif %}>Active</option>
                    <option value="Inactive" {% if c.status == "Inactive" %}selected{% endif %}>Inactive</option>
                  </select>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-warning">Update</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


          </div>
        </div>

      </div>
    </div>
  </div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('update_profile') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <!-- Hidden user ID -->
          <input type="hidden" name="user_id" value="{{ user._id }}">

          <div class="mb-2">
            <label class="form-label">First Name</label>
            <input type="text" name="first_name" class="form-control" value="{{ user.first_name }}" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Last Name</label>
            <input type="text" name="last_name" class="form-control" value="{{ user.last_name }}" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control" value="{{ user.email }}" required>
          </div>

<div class="mb-2">
  <label class="form-label">Role</label>
  <select name="role" class="form-select" required {% if user.role != 'admin' %}disabled{% endif %}>
    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
    <option value="manager" {% if user.role == 'manager' %}selected{% endif %}>Manager</option>
    <option value="cluster_manager" {% if user.role == 'cluster_manager' %}selected{% endif %}>Cluster Manager</option>
    <option value="commercial_officer" {% if user.role == 'commercial_officer' %}selected{% endif %}>Commercial Officer</option>
    <option value="billing_officer" {% if user.role == 'billing_officer' %}selected{% endif %}>Billing Officer</option>
    <option value="project_officer" {% if user.role == 'project_officer' %}selected{% endif %}>Project Officer</option>
    <option value="area_manager" {% if user.role == 'area_manager' %}selected{% endif %}>Area Manager</option>
    <option value="scheme_manager" {% if user.role == 'scheme_manager' %}selected{% endif %}>Scheme Manager</option>
    <option value="plumber" {% if user.role == 'plumber' %}selected{% endif %}>Plumber</option>
    <option value="me_officer" {% if user.role == 'me_officer' %}selected{% endif %}>M&E Officer</option>
  </select>
</div>


<div class="mb-2">
  <label class="form-label">Umbrella Authority</label>
  <select name="umbrella_id" class="form-select" required {% if user.role|string != 'admin' %}disabled{% endif %}>
    <!-- Default option -->
    <option value="" {% if not user.umbrella_id|string %}selected{% endif %}>Select Umbrella</option>
    {% for umbrella in umbrellas %}
      <option value="{{ umbrella._id }}" {% if user.umbrella_id|string == umbrella._id|string %}selected{% endif %}>
        {{ umbrella.umbrella }}
      </option>
    {% endfor %}
  </select>
</div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('change_password') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Change Password</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <!-- Hidden user ID -->
          <input type="hidden" name="user_id" value="{{ user._id }}">
          <input type="password" name="new_password" class="form-control mb-2" placeholder="New Password" required>
          <input type="password" name="confirm_password" class="form-control" placeholder="Confirm New Password" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-warning">Update Password</button>
        </div>
      </div>
    </form>
  </div>
</div>


  <!-- Add Umbrella Modal -->
  <div class="modal fade" id="addUmbrellaModal" tabindex="-1" aria-labelledby="addUmbrellaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="{{ url_for('add_umbrella') }}">
          <div class="modal-header">
            <h5 class="modal-title" id="addUmbrellaModalLabel">Add New Umbrella</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="new_umbrella" class="form-label">Umbrella Name</label>
              <input type="text" class="form-control" id="new_umbrella" name="umbrella" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Add Umbrella</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const tabButtons = document.querySelectorAll('#sidebarTabs button[data-bs-toggle="pill"]');
  const activeTabId = localStorage.getItem('activeTab');

  if (activeTabId) {
    // Find the button using the exact stored id
    const triggerEl = document.getElementById(activeTabId);
    if (triggerEl) {
      const tab = new bootstrap.Tab(triggerEl);
      tab.show();
    }
  }

  tabButtons.forEach(btn => {
    btn.addEventListener('shown.bs.tab', function (event) {
      // Store the full button id
      localStorage.setItem('activeTab', event.target.id);
    });
  });
});
</script>


</body>
</html>
